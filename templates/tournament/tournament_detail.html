{% extends "base.html" %}
{% load i18n %}
{% block title %}{{ tour.title }}{% endblock %}
{% block content %}
<h2>{{ tour.title }}</h2>
<p>
  <strong>Игра:</strong> {{ tour.game.title }} <br>
  <strong>Сетка:</strong> {{ tour.get_bracket_type_display }} <br>
  <strong>Регистрация:</strong>
  {% if tour.status == "registration" %}открыта{% else %}закрыта{% endif %} <br>
  <strong>Статус:</strong> {{ tour.get_status_display }}
</p>

{% if user.role == 'manager' and tour.status == 'registration' %}
  <button class="btn btn-primary mb-3" 
          data-toggle="modal" 
          data-target="#registerTeamModal">
    Зарегистрировать команду
  </button>

  <!-- Modal -->
  <div class="modal fade" id="registerTeamModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <form method="post" action="{% url 'team_register' tour.id %}">
          {% csrf_token %}
          <div class="modal-header">
            <h5 class="modal-title">Регистрация в турнире</h5>
            <button type="button" class="close" data-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label for="teamSelect">Выберите команду</label>
              <select name="team_id" id="teamSelect" class="form-select">
                {% for team in user.teams_managed.all %}
                  {% if team not in teams %}
                    <option value="{{ team.id }}">{{ team.name }}</option>
                  {% endif %}
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Отмена</button>
            <button type="submit" class="btn btn-primary">Зарегистрировать</button>
          </div>
        </form>
      </div>
    </div>
  </div>
{% endif %}

<h4>Команды ({{ teams.count }})</h4>
<ul>
  {% for team in teams %}
    <li>{{ team.name }} — {{ team.members.count }} игроков
      <ul class="small">
        {% for p in team.members.all %}<li>{{ p.username }}</li>{% endfor %}
      </ul>
    </li>
  {% endfor %}
</ul>

{% if user in tour.moderators.all and tour.status == 'registration' %}
  <form method="post" action="{% url 'tour_generate' tour.id %}" class="d-inline">
    {% csrf_token %}
    <button class="btn btn-outline-primary">Сгенерировать сетку</button>
  </form>

  {% if matches %}
    <form method="post" action="{% url 'tour_start' tour.id %}" class="d-inline">
      {% csrf_token %}
      <button class="btn btn-success">Запустить турнир</button>
    </form>
  {% endif %}
{% endif %}

{% if matches %}
  <h4 class="mt-4">Матчи ({{ matches.count }})</h4>
  <table class="table table-sm">
    <thead><tr><th>Раунд</th><th>Матч</th></tr></thead>
    <tbody>
      {% for m in matches %}
        <tr>
          <td>{{ m.round }}</td>
          <td>
            <a href="{% url 'match_detail' m.id %}">
              {{ m.team_a }} vs {{ m.team_b }}
            </a>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
{% endif %}


<a href="{% url 'dashboard' %}" class="btn btn-link">← на главную</a>


{% endblock %}
